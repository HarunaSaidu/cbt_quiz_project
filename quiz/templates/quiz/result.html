{% extends 'quiz/base.html' %}
{% load my_custom_filters %}

{% block title %}Quiz Results - CBT Quiz{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        text-align: center;
        padding: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin: -40px -40px 40px -40px;
    }
    
    .score-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: white;
        color: #667eea;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 30px auto;
        font-size: 3em;
        font-weight: bold;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .score-label {
        font-size: 0.3em;
        margin-top: 10px;
        color: #6c757d;
    }
    
    .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .detail-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .detail-box h3 {
        color: #667eea;
        font-size: 2em;
        margin-bottom: 5px;
    }
    
    .detail-box p {
        color: #6c757d;
    }
    
    .review-section {
        margin-top: 40px;
    }
    
    .question-review {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid #e0e0e0;
    }
    
    .question-review.correct {
        border-left-color: #28a745;
        background: #f0fff4;
    }
    
    .question-review.incorrect {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
    
    .answer-indicator {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        margin-left: 10px;
    }
    
    .correct-indicator {
        background: #28a745;
        color: white;
    }
    
    .incorrect-indicator {
        background: #dc3545;
        color: white;
    }
    
    .actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content">
    <div class="result-header">
        <h1>üéâ Quiz Completed!</h1>
        <div class="score-circle">
            {{ attempt.score }}/{{ attempt.total_questions }}
            <div class="score-label">{{ percentage|floatformat:0 }}%</div>
        </div>
        <h2>{{ attempt.student_name }}</h2>
        
        {% if percentage >= 70 %}
        <p style="font-size: 1.5em; margin-top: 20px;">üèÜ Excellent Performance! You've won a book!</p>
        {% elif percentage >= 50 %}
        <p style="font-size: 1.5em; margin-top: 20px;">üëè Great Job! Keep practicing!</p>
        {% else %}
        <p style="font-size: 1.5em; margin-top: 20px;">üí™ Good Effort! Review and try again!</p>
        {% endif %}
    </div>
    
    <div class="result-details">
        <div class="detail-box">
            <h3>{{ attempt.score }}</h3>
            <p>Correct Answers</p>
        </div>
        
        <div class="detail-box">
            <h3>{{ attempt.total_questions|add:"-"|add:attempt.score }}</h3>
            <p>Wrong Answers</p>
        </div>
        
        <div class="detail-box">
            <h3>{{ attempt.time_taken|div:60|floatformat:0 }}m {{ attempt.time_taken|mod:60 }}s</h3>
            <p>Time Taken</p>
        </div>
        
        <div class="detail-box">
            <h3>{{ percentage|floatformat:0 }}%</h3>
            <p>Score Percentage</p>
        </div>
    </div>
    
    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <h3 style="color: #333; margin-bottom: 10px;">üìö Prize Information:</h3>
        <p style="line-height: 1.8;">
            {% if percentage >= 80 %}
            <strong style="color: #28a745;">Congratulations!</strong> You scored {{ percentage|floatformat:0 }}% and qualify for a book prize! 
            Please see the organizers to collect your prize.
            {% else %}
            Students who score 80% and above win book prizes. Your score: {{ percentage|floatformat:0 }}%. 
            Keep practicing and try again to win a prize!
            {% endif %}
        </p>
    </div>
    
    <div class="review-section">
        <h2 style="color: #667eea; margin-bottom: 20px;">üìù Answer Review</h2>
        
        {% for result in results %}
        <div class="question-review {% if result.is_correct %}correct{% else %}incorrect{% endif %}">
            <p style="font-weight: 600; margin-bottom: 15px;">
                Question {{ forloop.counter }}: {{ result.question.question_text }}
                <span class="answer-indicator {% if result.is_correct %}correct-indicator{% else %}incorrect-indicator{% endif %}">
                    {% if result.is_correct %}‚úì Correct{% else %}‚úó Wrong{% endif %}
                </span>
            </p>
            
            <div style="margin-left: 20px; line-height: 1.8;">
                <p>
                    <strong>Your Answer:</strong> 
                    <span style="{% if not result.is_correct %}color: #dc3545;{% else %}color: #28a745;{% endif %}">
                        {{ result.selected|default:"Not Answered" }}
                        {% if result.selected == 'A' %} - {{ result.question.option_a }}
                        {% elif result.selected == 'B' %} - {{ result.question.option_b }}
                        {% elif result.selected == 'C' %} - {{ result.question.option_c }}
                        {% elif result.selected == 'D' %} - {{ result.question.option_d }}
                        {% endif %}
                    </span>
                </p>
                
                {% if not result.is_correct %}
                <p>
                    <strong>Correct Answer:</strong> 
                    <span style="color: #28a745;">
                        {{ result.correct }}
                        {% if result.correct == 'A' %} - {{ result.question.option_a }}
                        {% elif result.correct == 'B' %} - {{ result.question.option_b }}
                        {% elif result.correct == 'C' %} - {{ result.question.option_c }}
                        {% elif result.correct == 'D' %} - {{ result.question.option_d }}
                        {% endif %}
                    </span>
                </p>
                {% endif %}
                
                {% if result.question.explanation %}
                <p style="color: #6c757d; margin-top: 10px; font-style: italic;">
                    üí° {{ result.question.explanation }}
                </p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="actions">
        <a href="{% url 'index' %}" class="btn">
            üîÑ Take Quiz Again
        </a>
        <a href="{% url 'leaderboard' %}" class="btn btn-secondary">
            üèÜ View Leaderboard
        </a>
    </div>
</div>
{% endblock %}